<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Live Circle-Filled Text</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #ui {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        #answerInput {
            font-size: 18px;
            padding: 5px;
            width: 300px;
        }
    </style>
</head>

<body>
    <div id="ui">

        <input id="answerInput" type="text" placeholder="What made you to feel that way?">
    </div>
    <div id="sketch-holder"></div>

    <script>
        let pgMask;
        let userAnswer = '';

        function setup() {
            // 캔버스 생성
            const canvas = createCanvas(windowWidth, windowHeight);
            canvas.parent('sketch-holder');
            textAlign(CENTER, CENTER);
            pixelDensity(1);

            // 마스크용 그래픽
            pgMask = createGraphics(width, height);
            pgMask.pixelDensity(1);

            // 입력창 이벤트
            select('#answerInput').input(e => {
                userAnswer = e.target.value;
                redraw();  // noLoop 상태에서 draw()를 한 번 호출
            });

            noLoop();  // 자동 루프 꺼두기
        }

        // 텍스트 줄바꿈 헬퍼
        function wrapText(gfx, txt, maxW) {
            const words = txt.split(' ');
            let line = '', out = [];
            for (let w of words) {
                const test = line ? line + ' ' + w : w;
                if (gfx.textWidth(test) <= maxW) line = test;
                else { out.push(line); line = w; }
            }
            out.push(line);
            return out.join('\n');
        }

        function draw() {
            background(255);

            // 1) pgMask에 텍스트 그리기
            const bigSize = 200;
            const leading = bigSize * 1.1;
            pgMask.clear();
            pgMask.background(0);
            pgMask.fill(255);
            pgMask.noStroke();
            pgMask.textSize(bigSize);
            pgMask.textAlign(CENTER, CENTER);
            pgMask.textLeading(leading);

            const wrapped = wrapText(pgMask, userAnswer, width * 0.9);
            pgMask.text(wrapped, width / 2, height / 2);

            // 2) mask 픽셀 검사 → circle로 채우기
            const smallSize = 20;
            const rowStep = smallSize * 0.8;
            const colStep = smallSize * 0.6;
            const radius = Math.min(rowStep, colStep) * 0.5;

            noStroke();
            fill(0);

            for (let y = 0; y < height; y += rowStep) {
                let inSeg = false, startX = 0, segs = [];
                for (let x = 0; x < width; x++) {
                    // 마스크 픽셀 읽기
                    if (pgMask.get(x, y)[0] > 128) {
                        if (!inSeg) { inSeg = true; startX = x; }
                    } else if (inSeg) {
                        segs.push([startX, x - 1]);
                        inSeg = false;
                    }
                }
                if (inSeg) segs.push([startX, width - 1]);

                // 분할된 구간마다 원 그리기
                for (let [x0, x1] of segs) {
                    for (let x = x0; x <= x1; x += colStep) {
                        circle(x, y, radius * 2);
                    }
                }
            }
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
            pgMask.resizeCanvas(width, height);
            redraw();
        }
    </script>
</body>

</html>